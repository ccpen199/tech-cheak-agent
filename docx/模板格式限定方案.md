# 模板格式限定方案

## 一、需求背景

老师们下载模板后填写时，容易出现格式错乱问题：
- 序号格式不统一（1. vs 一、vs ①）
- 字体、字号不一致
- 段落格式混乱
- 表格格式被破坏
- 样式被修改

## 二、解决方案概述

采用**多层次防护 + 自动化处理**的方案：
1. **模板层面**：在Word模板中设置格式保护和内容控件
2. **验证层面**：上传后验证格式是否符合模板规范
3. **修复层面**：自动修复常见格式问题
4. **提示层面**：提供详细的格式错误提示

## 三、详细方案

### 方案A：Word文档保护 + 内容控件（推荐）

#### 3.1 模板预处理
**目标**：在模板文件中设置格式保护，限定填写区域

**实现方式**：
1. **使用Word"限制编辑"功能**
   - 保护文档结构，只允许在特定区域编辑
   - 锁定样式，防止修改字体、字号、段落格式
   - 锁定表格结构，防止增删行列

2. **使用内容控件（Content Controls）**
   - 在需要填写的区域插入内容控件
   - 设置控件属性：
     - 标题控件：限定样式（如"标题1"、"标题2"）
     - 文本控件：限定格式（纯文本/富文本）
     - 列表控件：自动编号，防止手动输入序号
   - 设置占位符文本，提示填写要求

3. **使用样式库**
   - 预定义样式：标题1、标题2、正文、列表等
   - 设置自动编号样式，确保序号格式统一
   - 锁定样式，防止用户修改

**优点**：
- ✅ 从源头防止格式错乱
- ✅ 用户体验好，填写时自动应用格式
- ✅ 不需要额外开发

**缺点**：
- ⚠️ 需要手动处理每个模板文件
- ⚠️ 部分老版本Word可能不支持内容控件

#### 3.2 技术实现
```javascript
// 使用 docx 库或 docxtemplater 处理Word文档
// 1. 读取模板
// 2. 添加内容控件和保护设置
// 3. 保存为受保护的模板
```

---

### 方案B：模板规范定义 + 格式验证（当前可实施）

#### 3.1 模板规范定义
**目标**：为每个模板定义格式规范配置文件

**实现方式**：
1. **创建模板规范配置文件**（JSON格式）
   ```json
   {
     "templateId": "SY001",
     "templateName": "童萌-节庆活动方案模板",
     "sections": [
       {
         "name": "节日",
         "type": "text",
         "required": true,
         "format": {
           "font": "宋体",
           "size": 12
         }
       },
       {
         "name": "环节流程",
         "type": "list",
         "required": true,
         "format": {
           "numbering": "1. 2. 3.",
           "indent": 2
         }
       }
     ],
     "rules": [
       {
         "type": "heading",
         "pattern": "^环节\\d+:",
         "format": "标题2"
       },
       {
         "type": "list",
         "pattern": "^\\d+\\.",
         "required": true
       }
     ]
   }
   ```

2. **模板识别**
   - 根据文件名或文档内容识别模板类型
   - 加载对应的规范配置

#### 3.2 格式验证引擎
**目标**：验证上传的文档是否符合模板规范

**实现方式**：
1. **文档解析**
   - 使用 `mammoth` 或 `docx` 库解析Word文档
   - 提取文档结构（标题、段落、列表、表格）

2. **格式验证**
   - 验证标题格式是否符合规范
   - 验证序号格式是否统一
   - 验证字体、字号是否符合要求
   - 验证段落格式是否正确
   - 验证必填区域是否已填写

3. **错误报告**
   - 生成详细的格式错误报告
   - 标注错误位置和类型
   - 提供修复建议

**优点**：
- ✅ 可以自动化实现
- ✅ 不需要修改模板文件
- ✅ 可以检测格式问题

**缺点**：
- ⚠️ 只能检测，不能防止
- ⚠️ 需要维护规范配置

---

### 方案C：格式自动修复（补充方案）

#### 3.1 自动修复引擎
**目标**：自动修复常见格式问题

**实现方式**：
1. **序号修复**
   - 统一序号格式（1. 2. 3.）
   - 修复断号问题
   - 修复格式不一致问题

2. **样式修复**
   - 统一字体、字号
   - 修复段落格式
   - 修复列表格式

3. **结构修复**
   - 修复表格结构
   - 修复标题层级

**优点**：
- ✅ 自动修复，减少人工干预
- ✅ 提高文档质量

**缺点**：
- ⚠️ 可能误修复
- ⚠️ 需要大量测试

---

## 四、推荐实施方案

### 阶段一：快速实施（1-2周）
**采用方案B：模板规范定义 + 格式验证**

1. **创建模板规范配置**
   - 为5个模板分别创建规范配置文件
   - 定义必填区域、格式要求、验证规则

2. **增强格式验证器**
   - 扩展 `formatChecker.js`
   - 添加模板特定的格式验证逻辑
   - 生成详细的格式错误报告

3. **前端展示**
   - 显示模板特定的格式错误
   - 提供格式修复建议

### 阶段二：深度优化（2-4周）
**结合方案A：Word文档保护**

1. **模板预处理工具**
   - 开发工具批量处理模板文件
   - 添加内容控件和格式保护
   - 生成受保护的模板

2. **模板更新流程**
   - 建立模板版本管理
   - 提供模板更新机制

### 阶段三：智能化（可选）
**添加方案C：格式自动修复**

1. **智能修复引擎**
   - 基于规则和AI的格式修复
   - 学习用户修复习惯

---

## 五、技术栈建议

### 后端
- **Word文档处理**：
  - `mammoth`：提取文本和基本格式
  - `docx`：创建和修改Word文档
  - `docxtemplater`：模板填充（如需要）

- **格式验证**：
  - 自定义验证引擎
  - 正则表达式匹配
  - 文档结构分析

### 前端
- **格式错误展示**：
  - 高亮显示格式错误
  - 提供修复建议
  - 可视化格式规范

---

## 六、实施步骤

### Step 1: 模板分析（1天）
- [ ] 分析5个模板的结构和格式要求
- [ ] 识别关键格式要素（标题、列表、表格等）
- [ ] 列出常见格式问题

### Step 2: 规范定义（2-3天）
- [ ] 为每个模板创建规范配置文件
- [ ] 定义验证规则
- [ ] 编写规范文档

### Step 3: 验证引擎开发（3-5天）
- [ ] 扩展格式验证器
- [ ] 实现模板识别逻辑
- [ ] 实现格式验证规则
- [ ] 生成错误报告

### Step 4: 前端集成（2-3天）
- [ ] 显示模板特定的格式错误
- [ ] 提供格式修复建议
- [ ] 优化用户体验

### Step 5: 测试和优化（2-3天）
- [ ] 测试各种格式问题场景
- [ ] 优化验证规则
- [ ] 收集用户反馈

---

## 七、预期效果

1. **格式问题检测率**：90%+
2. **格式错误提示准确率**：85%+
3. **用户填写格式规范率**：提升50%+
4. **格式修复时间**：减少70%+

---

## 八、风险和注意事项

1. **模板更新**：模板修改后需要同步更新规范配置
2. **兼容性**：不同Word版本可能有格式差异
3. **误报**：格式验证可能产生误报，需要持续优化
4. **性能**：大量文档验证可能影响性能，需要优化

---

## 九、后续扩展

1. **格式修复功能**：自动修复常见格式问题
2. **格式模板库**：建立格式模板库，支持更多模板类型
3. **AI辅助**：使用AI识别和修复格式问题
4. **格式培训**：提供格式规范培训材料

