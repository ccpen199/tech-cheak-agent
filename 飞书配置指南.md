# 飞书云表格配置指南

本指南将帮助您完成飞书云表格的完整配置，使系统能够自动将教案评审结果登记到飞书多维表格中。

## 📋 配置流程概览

1. ✅ 创建飞书应用
2. ✅ 配置应用权限
3. ✅ 创建多维表格
4. ✅ 获取表格信息（App Token 和 Table ID）
5. ✅ 配置环境变量
6. ✅ 测试连接

---

## 步骤1：创建飞书应用

### 1.1 登录飞书开放平台

1. 访问 [飞书开放平台](https://open.feishu.cn)
2. 使用企业管理员账号登录（需要管理员权限）

### 1.2 创建企业自建应用

1. 点击右上角头像，选择 **"进入开发者后台"**
2. 点击 **"创建企业自建应用"**
3. 填写应用信息：
   - **应用名称**：教案评审系统（或您喜欢的名称）
   - **应用描述**：自动处理教案文档并登记到多维表格
   - **应用图标**：可选，上传一个图标
4. 点击 **"创建"**

### 1.3 获取 App ID 和 App Secret

创建成功后，在应用详情页面：

1. 找到 **"凭证与基础信息"** 部分
2. 记录以下信息：
   - **App ID**：例如 `cli_xxxxxxxxxxxxx`
   - **App Secret**：点击"显示"后复制，例如 `xxxxxxxxxxxxxxxxxxxxx`

⚠️ **重要**：App Secret 只显示一次，请妥善保存！

---

## 步骤2：配置应用权限

### 2.1 添加权限范围

在应用详情页面，找到 **"权限管理"** 标签：

1. 点击 **"添加权限范围"**
2. 搜索并添加以下权限：

   **必需权限：**
   - ✅ `bitable:app` - 编辑多维表格
   - ✅ `bitable:app:readonly` - 查看多维表格
   - ✅ `drive:drive` - 上传文件到云文档
   - ✅ `drive:drive:readonly` - 查看云文档

3. 点击 **"确定"** 保存

### 2.2 申请权限

1. 在权限列表中，找到刚添加的权限
2. 点击 **"申请权限"**
3. 填写申请理由（例如：用于教案评审系统自动登记文档）
4. 提交申请后，等待管理员审批

⚠️ **注意**：如果您的账号是管理员，权限会自动通过；否则需要等待审批。

---

## 步骤3：创建多维表格

### 3.1 创建表格

1. 打开飞书，进入 **"云文档"**
2. 点击 **"新建"** → **"多维表格"**
3. 命名为 **"教案收案登记表"**（或您喜欢的名称）

### 3.2 创建字段

根据图片中的表格结构，创建以下字段：

| 字段名称 | 字段类型 | 说明 |
|---------|---------|------|
| **教案名称** | 文本 | 教案的名称 |
| **教案编号** | 文本 | 教案的编号 |
| **教案评价** | 多行文本 | 教案的评价内容 |
| **修改意见** | 多行文本 | 修改建议 |
| **错别字** | 文本 | 错别字信息 |
| **状态** | 单选 | 状态选项（待审核、已审核、已修改等） |

**创建字段步骤：**

1. 点击表格右上角的 **"字段配置"**（齿轮图标）
2. 点击 **"+ 添加字段"**
3. 依次添加上述字段：
   - 对于 **"状态"** 字段，选择 **"单选"** 类型，并添加选项：
     - 待审核
     - 已审核
     - 已修改
     - 已完成

### 3.3 设置表格权限

1. 点击表格右上角的 **"分享"** 按钮
2. 选择 **"获得链接的人可编辑"** 或 **"获得链接的人可查看"**
3. 确保应用有权限访问此表格

---

## 步骤4：获取表格信息

### 4.1 获取 App Token

1. 打开您创建的多维表格
2. 点击浏览器地址栏，查看URL
3. URL格式类似：`https://xxx.feishu.cn/base/xxxxxxxxxxxxxxxxxxxxx?table=xxxxxxxxxx`
4. 从URL中提取 **App Token**：
   - 在 `base/` 后面的部分，到 `?` 之前
   - 例如：如果URL是 `https://xxx.feishu.cn/base/AppToken123456?table=...`
   - 那么 App Token 就是 `AppToken123456`

**或者：**

1. 在多维表格中，点击右上角 **"..."** 菜单
2. 选择 **"复制链接"**
3. 从复制的链接中提取 App Token

### 4.2 获取 Table ID

1. 在同一个URL中，找到 `table=` 后面的部分
2. 这就是 **Table ID**
3. 例如：如果URL是 `...?table=TableID789012`
   - 那么 Table ID 就是 `TableID789012`

**或者：**

1. 打开表格后，查看浏览器开发者工具（F12）
2. 在 Network 标签中，查看API请求
3. 从请求URL中可以看到 `table_id` 参数

---

## 步骤5：配置环境变量

### 5.1 创建 .env 文件

1. 在 `backend` 目录下，复制示例文件：
   ```bash
   cd backend
   cp .env.example .env
   ```

2. 使用文本编辑器打开 `backend/.env` 文件

### 5.2 填入配置信息

将步骤1和步骤4中获取的信息填入：

```env
# 飞书应用配置
LARK_APP_ID=cli_xxxxxxxxxxxxx
LARK_APP_SECRET=xxxxxxxxxxxxxxxxxxxxx

# 飞书多维表格配置
LARK_BITABLE_APP_TOKEN=AppToken123456
LARK_BITABLE_TABLE_ID=TableID789012

# 后端服务端口（可选）
PORT=4004
```

⚠️ **重要**：
- 不要将 `.env` 文件提交到Git仓库
- 确保 `.env` 文件在 `.gitignore` 中

---

## 步骤6：测试连接

### 6.1 重启后端服务

配置完成后，重启后端服务以加载新的环境变量：

```bash
# 停止当前服务（如果正在运行）
cd backend
# 按 Ctrl+C 停止

# 重新启动
npm start
```

### 6.2 测试上传文档

1. 启动前端和后端服务
2. 在前端页面上传一个测试文档
3. 检查后端控制台输出：
   - 如果看到 "文档已成功登记到飞书"，说明配置成功
   - 如果看到错误信息，请检查配置

### 6.3 验证数据

1. 打开飞书多维表格
2. 检查是否新增了一条记录
3. 验证字段是否正确填充

---

## 🔧 常见问题排查

### 问题1：获取token失败

**错误信息**：`获取飞书token失败: invalid param`

**解决方法**：
- 检查 `LARK_APP_ID` 和 `LARK_APP_SECRET` 是否正确
- 确保没有多余的空格或引号
- 确认应用已创建且状态正常

### 问题2：创建记录失败

**错误信息**：`创建记录失败: no permission`

**解决方法**：
- 检查应用权限是否已申请并通过
- 确认表格的 App Token 和 Table ID 正确
- 检查表格权限设置，确保应用可以访问

### 问题3：字段名称不匹配

**错误信息**：`创建记录失败: field not found`

**解决方法**：
- 检查表格中的字段名称是否与代码中的完全一致
- 字段名称区分大小写
- 确保没有多余的空格

### 问题4：无法上传文件

**错误信息**：`上传文件失败`

**解决方法**：
- 检查 `drive:drive` 权限是否已添加
- 确认文件大小不超过限制
- 检查文件路径是否正确

---

## 📝 字段映射说明

系统会自动将以下信息映射到飞书表格：

| 系统字段 | 飞书表格字段 | 说明 |
|---------|-------------|------|
| `docName` | 教案名称 | 从文档中提取的教案名称 |
| `docNumber` | 教案编号 | 从文档中提取的编号 |
| `reviewComments` | 教案评价 | 评审意见（包含错别字和格式问题） |
| `reviewComments` | 修改意见 | 同上 |
| `typoCount` | 错别字 | 错别字数量信息 |
| - | 状态 | 默认为"待审核" |

---

## ✅ 配置完成检查清单

- [ ] 已创建飞书应用
- [ ] 已获取 App ID 和 App Secret
- [ ] 已添加所有必需权限
- [ ] 权限已通过审批
- [ ] 已创建多维表格
- [ ] 已创建所有必需字段
- [ ] 已获取 App Token 和 Table ID
- [ ] 已创建 `.env` 文件并填入配置
- [ ] 已重启后端服务
- [ ] 已测试上传文档并验证数据

---

## 🎉 完成！

配置完成后，系统将自动：
1. 提取文档信息（编号、名称）
2. 检测错别字和格式问题
3. 生成处理后的文档
4. 将信息登记到飞书多维表格
5. 上传处理后的文档（如果配置了附件字段）

如有问题，请查看后端控制台的错误日志进行排查。

